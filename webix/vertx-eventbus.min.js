!function(a){webix.require("/webix/sockjs.min.js",function(){window.EventBus=a(this.SockJS)})}(function(a){function b(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a,b){return b=16*Math.random(),("y"===a?8|3&b:0|b).toString(16)})}function c(a,b){if(a){if(!b)return a;for(var c in a)a.hasOwnProperty(c)&&"undefined"==typeof b[c]&&(b[c]=a[c])}return b||{}}var d=function(b,c){var f,g,e=this;c=c||{},this.pingInterval=c.vertxbus_ping_interval||5e3,this.pingTimerID=null,this.reconnectEnabled=!1,this.reconnectAttempts=0,this.reconnectTimerID=null,this.maxReconnectAttempts=c.vertxbus_reconnect_attempts_max||1/0,this.reconnectDelayMin=c.vertxbus_reconnect_delay_min||1e3,this.reconnectDelayMax=c.vertxbus_reconnect_delay_max||5e3,this.reconnectExponent=c.vertxbus_reconnect_exponent||2,this.randomizationFactor=c.vertxbus_randomization_factor||.5,f=function(){var b,c,a=e.reconnectDelayMin*Math.pow(e.reconnectExponent,e.reconnectAttempts);return e.randomizationFactor&&(b=Math.random(),c=Math.floor(b*e.randomizationFactor*a),a=0===(1&Math.floor(10*b))?a-c:a+c),0|Math.min(a,e.reconnectDelayMax)},this.defaultHeaders=null,this.onerror=function(a){try{console.error(a)}catch(b){}},this.onevent=function(){return!1},this.onunhandled=function(a){try{"err"===a.type?e.onerror(a):a.event?console.warn("No handler found for event: %o. Message: %O",a.event,a):console.warn("No handler found for message: ",a)}catch(b){}},g=function(){e.sockJSConn=new a(b,null,c),e.state=d.CONNECTING,e.handlers={},e.replyHandlers={},e.sockJSConn.onopen=function(){e.enablePing(!0),e.state=d.OPEN,e.onopen&&e.onopen(),e.reconnectTimerID&&(e.reconnectAttempts=0,e.onreconnect&&e.onreconnect())},e.sockJSConn.onclose=function(a){e.state=d.CLOSED,e.pingTimerID&&clearInterval(e.pingTimerID),e.reconnectEnabled&&e.reconnectAttempts<e.maxReconnectAttempts&&(e.sockJSConn=null,e.reconnectTimerID=setTimeout(g,f()),++e.reconnectAttempts),e.onclose&&e.onclose(a)},e.sockJSConn.onmessage=function(a){var b,d,f,g;try{b=JSON.parse(a.data)}catch(c){b={type:"err",failureType:c.toString(),message:a.data}}if(b.replyAddress&&Object.defineProperty(b,"reply",{value:function(a,c,d){e.send(b.replyAddress,a,c,d)}}),e.handlers[b.address])for(d=e.handlers[b.address],f=0;f<d.length;f++)"err"===b.type?d[f]({failureCode:b.failureCode,failureType:b.failureType,message:b.message}):d[f](null,b);else e.replyHandlers[b.address]?(g=e.replyHandlers[b.address],delete e.replyHandlers[b.address],"err"===b.type?g({failureCode:b.failureCode,failureType:b.failureType,message:b.message}):g(null,b)):b.event&&e.onevent(b.event,b.message)||e.onunhandled(b)}},g()};return d.prototype.send=function(a,e,f,g){var h,i;if(this.state!==d.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof f&&(g=f,f={}),h={type:"send",address:a,headers:c(this.defaultHeaders,f),body:e},g&&(i=b(),h.replyAddress=i,this.replyHandlers[i]=g),this.sockJSConn.send(JSON.stringify(h))},d.prototype.publish=function(a,b,e){if(this.state!==d.OPEN)throw new Error("INVALID_STATE_ERR");this.sockJSConn.send(JSON.stringify({type:"publish",address:a,headers:c(this.defaultHeaders,e),body:b}))},d.prototype.registerHandler=function(a,b,e){if(this.state!==d.OPEN)throw new Error("INVALID_STATE_ERR");"function"==typeof b&&(e=b,b={}),this.handlers[a]||(this.handlers[a]=[],this.sockJSConn.send(JSON.stringify({type:"register",address:a,headers:c(this.defaultHeaders,b)}))),this.handlers[a].push(e)},d.prototype.unregisterHandler=function(a,b,e){var f,g;if(this.state!==d.OPEN)throw new Error("INVALID_STATE_ERR");f=this.handlers[a],f&&("function"==typeof b&&(e=b,b={}),g=f.indexOf(e),-1!==g&&(f.splice(g,1),0===f.length&&(this.sockJSConn.send(JSON.stringify({type:"unregister",address:a,headers:c(this.defaultHeaders,b)})),delete this.handlers[a])))},d.prototype.close=function(){this.state=d.CLOSING,this.enableReconnect(!1),this.sockJSConn.close()},d.CONNECTING=0,d.OPEN=1,d.CLOSING=2,d.CLOSED=3,d.prototype.enablePing=function(a){var c,b=this;a?(c=function(){b.sockJSConn.send(JSON.stringify({type:"ping"}))},b.pingInterval>0&&(c(),b.pingTimerID=setInterval(c,b.pingInterval))):b.pingTimerID&&(clearInterval(b.pingTimerID),b.pingTimerID=null)},d.prototype.enableReconnect=function(a){var b=this;b.reconnectEnabled=a,!a&&b.reconnectTimerID&&(clearTimeout(b.reconnectTimerID),b.reconnectTimerID=null,b.reconnectAttempts=0)},"undefined"==typeof exports?d:("undefined"!=typeof module&&module.exports?exports=module.exports=d:exports.EventBus=d,void 0)});